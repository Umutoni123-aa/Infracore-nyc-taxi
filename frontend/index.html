<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NYC Taxi Explorer</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: #0f172a;
    color: #e2e8f0;
    min-height: 100vh;
}
header {
    background: linear-gradient(135deg, #1e3a5f 0%, #f7c948 100%);
    padding: 20px 40px;
    display: flex;
    align-items: center;
    gap: 15px;
}
header h1 { font-size: 28px; font-weight: 800; color: #fff; }
main { padding: 30px 40px; max-width: 1400px; margin: 0 auto; }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom:30px; }
.stat-card { background:#1e293b; border-radius:12px; padding:20px; border-left:4px solid #f7c948; }
.stat-card .label { font-size:12px; color:#94a3b8; margin-bottom:8px; }
.stat-card .value { font-size:28px; font-weight:700; color:#f7c948; }
.filters { background:#1e293b; border-radius:12px; padding:20px; margin-bottom:30px; display:flex; gap:20px; flex-wrap:wrap; }
select,button { padding:10px; border-radius:8px; font-size:14px; }
button { background:#f7c948; color:#0f172a; font-weight:700; cursor:pointer; border:none; }
.charts-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(500px,1fr)); gap:25px; margin-bottom:30px; }
.chart-card { background:#1e293b; border-radius:12px; padding:25px; }
.chart-container { position:relative; height:300px; }
.table-card { background:#1e293b; border-radius:12px; padding:25px; margin-bottom:30px; overflow-x:auto; }
table { width:100%; border-collapse:collapse; }
th,td { padding:10px; border-bottom:1px solid #334155; }
.loading { text-align:center; padding:30px; }
</style>
</head>

<body>

<header>
<h1>NYC Taxi Explorer</h1>
</header>

<main>

<div class="stats-grid" id="stats-grid">
<div class="loading">Loading stats...</div>
</div>

<div class="filters">
<select id="borough-filter"><option value="">All Boroughs</option></select>
<select id="time-filter">
<option value="">All Times</option>
<option value="Morning Rush">Morning Rush</option>
<option value="Mid Morning">Mid Morning</option>
<option value="Afternoon">Afternoon</option>
<option value="Evening Rush">Evening Rush</option>
<option value="Night">Night</option>
<option value="Late Night">Late Night</option>
</select>
<select id="day-filter">
<option value="">All Days</option>
<option>Monday</option><option>Tuesday</option><option>Wednesday</option>
<option>Thursday</option><option>Friday</option>
<option>Saturday</option><option>Sunday</option>
</select>
<button onclick="applyFilters()">Apply Filters</button>
<button onclick="resetFilters()" style="background:#334155;color:#fff;">Reset</button>
</div>

<div class="charts-grid">
<div class="chart-card"><div class="chart-container"><canvas id="boroughChart"></canvas></div></div>
<div class="chart-card"><div class="chart-container"><canvas id="hourChart"></canvas></div></div>
<div class="chart-card"><div class="chart-container"><canvas id="dayChart"></canvas></div></div>
<div class="chart-card"><div class="chart-container"><canvas id="fareChart"></canvas></div></div>
</div>

<div class="table-card">
<h3>Borough Statistics</h3>
<table>
<thead><tr><th>Borough</th><th>Total Trips</th><th>Avg Fare</th><th>Avg Distance</th><th>Avg Duration</th><th>Avg Tip %</th></tr></thead>
<tbody id="borough-table"><tr><td colspan="6">Loading...</td></tr></tbody>
</table>
</div>

<div class="table-card">
<h3>Top Routes</h3>
<table>
<thead><tr><th>Pickup</th><th>Dropoff</th><th>Trips</th><th>Avg Fare</th><th>Distance</th></tr></thead>
<tbody id="routes-table"><tr><td colspan="5">Loading...</td></tr></tbody>
</table>
</div>

</main>

<script>
const API = "http://localhost:5000";
let boroughChart, hourChart, dayChart, fareChart;

async function fetchData(url){
    try{
        const res = await fetch(url);
        const json = await res.json();
        return json.success ? json.data : null;
    }catch(e){ console.error(e); return null; }
}

function buildQuery(filters){
    const params = new URLSearchParams(filters);
    return params.toString() ? "?" + params.toString() : "";
}

async function loadStats(filters={}){
    const data = await fetchData(API + "/api/stats" + buildQuery(filters));
    if(!data) return;
    document.getElementById("stats-grid").innerHTML = `
        <div class="stat-card"><div class="label">Total Trips</div><div class="value">${Number(data.total_trips).toLocaleString()}</div></div>
        <div class="stat-card"><div class="label">Avg Fare</div><div class="value">$${Number(data.avg_fare).toFixed(2)}</div></div>
        <div class="stat-card"><div class="label">Avg Distance</div><div class="value">${Number(data.avg_distance).toFixed(2)} mi</div></div>
        <div class="stat-card"><div class="label">Avg Duration</div><div class="value">${Number(data.avg_duration_mins).toFixed(1)} min</div></div>
        <div class="stat-card"><div class="label">Avg Speed</div><div class="value">${Number(data.avg_speed_mph).toFixed(1)} mph</div></div>
        <div class="stat-card"><div class="label">Avg Tip</div><div class="value">${Number(data.avg_tip_percentage).toFixed(1)}%</div></div>
    `;
}

async function loadCharts(filters={}){
    const query = buildQuery(filters);

    const byBorough = await fetchData(API+"/api/trips/by-borough"+query);
    const byHour = await fetchData(API+"/api/trips/by-hour"+query);
    const byDay = await fetchData(API+"/api/trips/by-day"+query);

    if(byBorough){
        if(boroughChart) boroughChart.destroy();
        boroughChart = new Chart(document.getElementById("boroughChart"),{
            type:"doughnut",
            data:{
                labels:byBorough.map(r=>r.borough),
                datasets:[{data:byBorough.map(r=>r.total_trips),
                backgroundColor:['#f7c948','#3b82f6','#10b981','#f43f5e','#8b5cf6']}]
            },
            options:{responsive:true,maintainAspectRatio:false}
        });

        if(fareChart) fareChart.destroy();
        fareChart = new Chart(document.getElementById("fareChart"),{
            type:"bar",
            data:{
                labels:byBorough.map(r=>r.borough),
                datasets:[{label:"Avg Fare",
                data:byBorough.map(r=>r.avg_fare),
                backgroundColor:"#f7c948"}]
            },
            options:{responsive:true,maintainAspectRatio:false}
        });

        document.getElementById("borough-table").innerHTML =
        byBorough.map(r=>`
        <tr>
            <td>${r.borough}</td>
            <td>${Number(r.total_trips).toLocaleString()}</td>
            <td>$${r.avg_fare}</td>
            <td>${r.avg_distance} mi</td>
            <td>${r.avg_duration} min</td>
            <td>${r.avg_tip_pct}%</td>
        </tr>`).join("");
    }

    if(byHour){
        if(hourChart) hourChart.destroy();
        hourChart = new Chart(document.getElementById("hourChart"),{
            type:"line",
            data:{
                labels:byHour.map(r=>r.hour_of_day+":00"),
                datasets:[{label:"Trips",data:byHour.map(r=>r.total_trips),
                borderColor:"#f7c948",fill:true}]
            },
            options:{responsive:true,maintainAspectRatio:false}
        });
    }

    if(byDay){
        if(dayChart) dayChart.destroy();
        dayChart = new Chart(document.getElementById("dayChart"),{
            type:"bar",
            data:{
                labels:byDay.map(r=>r.day_of_week),
                datasets:[{label:"Trips",data:byDay.map(r=>r.total_trips),
                backgroundColor:"#3b82f6"}]
            },
            options:{responsive:true,maintainAspectRatio:false}
        });
    }
}

async function loadTopRoutes(filters={}){
    const query = buildQuery(filters);
    const routes = await fetchData(API+"/api/trips/top-routes"+query+"&limit=10");
    if(!routes) return;

    document.getElementById("routes-table").innerHTML =
    routes.map(r=>`
        <tr>
            <td>${r.pickup_zone}</td>
            <td>${r.dropoff_zone}</td>
            <td>${Number(r.total_trips).toLocaleString()}</td>
            <td>$${r.avg_fare}</td>
            <td>${r.avg_distance} mi</td>
        </tr>`).join("");
}

async function applyFilters(){
    const filters={
        borough:document.getElementById("borough-filter").value,
        time_of_day:document.getElementById("time-filter").value,
        day:document.getElementById("day-filter").value
    };
    Object.keys(filters).forEach(k=>!filters[k]&&delete filters[k]);
    await loadStats(filters);
    await loadCharts(filters);
    await loadTopRoutes(filters);
}

function resetFilters(){
    document.getElementById("borough-filter").value="";
    document.getElementById("time-filter").value="";
    document.getElementById("day-filter").value="";
    init();
}

async function loadBoroughs(){
    const boroughs = await fetchData(API+"/api/boroughs");
    if(!boroughs) return;
    const sel=document.getElementById("borough-filter");
    boroughs.forEach(b=>{
        const opt=document.createElement("option");
        opt.value=b; opt.textContent=b;
        sel.appendChild(opt);
    });
}

async function init(){
    await loadBoroughs();
    await loadStats();
    await loadCharts();
    await loadTopRoutes();
}

init();
</script>

</body>
</html>
